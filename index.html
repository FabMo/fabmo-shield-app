<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>

<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script src="js/clipper.js"></script>

<style>

body{
	background:#eee;
}

input{
	position: absolute;
	width: 72px;
	height: 24px;
}

#input_submit{
	right: 30px;
	bottom: 30px;
	width:100px;
	height:100px;
}

#input_depth{
	displaY: none;
	position: absolute;
	right: 30px;
	bottom: 150px;
	width: 92px;
}
depth{
	displaY: none;
	position: absolute;
	right: 60px;
	bottom: 184px;
	font-familY: arial;
	font-size: 16px;
	color: #333;
}


#input_tool{
	displaY: none;
	position: absolute;
	right: 30px;
	bottom: 200px;
	width: 92px;
}

#input_radius{
	displaY: none;
}
#input_width{
	displaY: none;
}
#input_height{
	displaY: none;
}

tool{
	displaY: none;
	position: absolute;
	right: 32px;
	bottom: 234px;
	font-familY: arial;
	font-size: 16px;
	color: #333;
}

units{
	displaY: none;
	position: absolute;
	right: 50px;
	bottom: 130px;
	font-familY: arial;
	font-size: 16px;
	color: #333;
}

#action{
	display: none;
	position: absolute;
	right: 30px;
	top:   10px;
	width: 170px;
}

#input_undo{
	right: 30px;
	top: 50px;
	width:100px;
	height:50px;
}

#type{
	position: absolute;
	right: 30px;
	top:   5px;
	width: 100px;
}

</style>

</head>

<body onload="makeFrame(radius); parts();">

<select id="type" autocomplete="on">
  <option value="smd">SMD</option>
  <option value="dip">DIP</option>
</select>

<select id="action" autocomplete="off">
  <option value="route">ROUTE</option>
  <option value="end">END</option>
  <option value="resistor">RESISTOR</option>
  <option value="undo">UNDO</option>
  <option value="clear">CLEAR ALL</option>
</select>

<units>units: mm</units>

<tool>tool diameter:</tool>
<input id="input_tool" type="number" value="0.8" autocomplete="on" step="0.4"/>

<depth>cut depth:</depth>
<input id="input_depth" type="number" value="1.7" autocomplete="on" step="0.1" min="0"/>

<input id="input_submit" type="submit" value="SUBMIT&#x00A;JOB" onclick="make()"/>

<input id="input_undo" type="submit" value="UNDO" onclick="undo()"/>

<canvas id="myCanvas"></canvas>
   
<input id="input_width" type="number" value="62" autocomplete="off" step="0.1" min="0.1"/>
<input id="input_height" type="number" value="53" autocomplete="off" step="0.1" min="0.1"/>
<input id="input_radius" type="number" value="2" autocomplete="off" step="0.1" min="0"/>   

<script>

//TODO

//
//cleanup canvas
//save configuration
//

var g = ""
var frame1 = []
var path1 = []
var verts = 100
var xmin = -26
var ymin = -26.5
var xmax = 26
var ymax = 26.5
var radius = 2
var tool = parseFloat(document.getElementById("input_tool").value/2)
var scale = 100

var o //x offset
var c
var ctx
var sf
var r = 1

var input_width
var input_height
var input_radius

var myConfig = {}

var arduino = []
var arduino_pins = []
var pin_outlines = []
var grid = []
var vias = []
var nodes = []
var pins = []
var cut = []
var pocket = []
var outlines = []
var pts = []
var net = [[]]
var pin = 0
var connect = []
var trace = []
var paths = []

var seg = 0

var led = []
var resistor = []

function draw(){

var input_width_style = document.getElementById("input_width").style;
var input_height_style = document.getElementById("input_height").style;
var input_radius_style = document.getElementById("input_radius").style;

c = document.getElementById("myCanvas");
ctx = c.getContext("2d");

ctx.canvas.height = $(window).innerHeight()-30
ctx.canvas.width = $(window).innerWidth()-30

if(((ctx.canvas.height)/((ymax-ymin))*xmax*2)+100>ctx.canvas.width){
	sf = (ctx.canvas.width-230)/((xmax*2))
}
else{
	sf = (ctx.canvas.height-100)/((ymax*2))
}

input_width_style.left=((ctx.canvas.width/2)-30 + "px")
input_width_style.top=(ctx.canvas.height/2+(ymax*sf)+24 + "px")

input_height_style.left=((ctx.canvas.width/2)-(xmax*sf)-100 + "px")
input_height_style.top=(ctx.canvas.height/2-12 + "px")

input_radius_style.left=((ctx.canvas.width/2)+(xmax*sf)+24 + "px")
input_radius_style.top=(ctx.canvas.height/2-(ymax*sf) + "px")

ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
ctx.lineJoin="round";

//dims
/*
ctx.beginPath()
	ctx.lineWidth="1"
	ctx.strokeStyle="red"
	ctx.lineTo((ctx.canvas.width/2)+(xmin*sf),(ctx.canvas.height/2+(ymax*sf)+32))
	ctx.lineTo((ctx.canvas.width/2)+(xmax*sf),(ctx.canvas.height/2+(ymax*sf)+32))
	ctx.lineTo((ctx.canvas.width/2)+(xmax*sf),(ctx.canvas.height/2+(ymax*sf)+22))
	ctx.moveTo((ctx.canvas.width/2)+(xmin*sf),(ctx.canvas.height/2+(ymax*sf)+32))
	ctx.lineTo((ctx.canvas.width/2)+(xmin*sf),(ctx.canvas.height/2+(ymax*sf)+22))
ctx.stroke()

ctx.beginPath()
	ctx.lineWidth="1"
	ctx.strokeStyle="green"
	ctx.lineTo((ctx.canvas.width/2-37)-(sf*(xmax)),ctx.canvas.height/2+(ymin*sf))
	ctx.lineTo((ctx.canvas.width/2-37)-(sf*(xmax)),ctx.canvas.height/2+(ymax*sf))
	ctx.lineTo((ctx.canvas.width/2-27)-(sf*(xmax)),ctx.canvas.height/2+(ymax*sf))
	ctx.moveTo((ctx.canvas.width/2-27)-(sf*(xmax)),ctx.canvas.height/2+(ymin*sf))
	ctx.lineTo((ctx.canvas.width/2-37)-(sf*(xmax)),ctx.canvas.height/2+(ymin*sf))
ctx.stroke()

if(radius>0){
	ctx.beginPath()
		ctx.lineWidth="1"
		ctx.strokeStyle="#555"
		ctx.lineTo(ctx.canvas.width/2+((xmax-radius)*sf),ctx.canvas.height/2+((ymin+radius)*sf))
		ctx.lineTo((frame1[63].X*sf)+ctx.canvas.width/2,(frame1[63].Y*sf)+ctx.canvas.height/2)	
	ctx.stroke()
}

*/

ctx.fillStyle="#aaa"

for(i=0;i<pin_outlines.length;i++){

	ctx.beginPath()
	for(j=0;j<pin_outlines[i].length;j++){
		ctx.lineTo((ctx.canvas.width/2)+(pin_outlines[i][j].X*sf),(ctx.canvas.height/2)+(pin_outlines[i][j].Y*sf))
	}
	ctx.fill()
}

//ctx.lineWidth=0.8*sf
//ctx.strokeStyle="#ff00ff"

ctx.lineWidth="0.6"
ctx.strokeStyle="#000"

for(i=0;i<outlines.length;i++){
	ctx.beginPath()
	for(j=0;j<outlines[i].length;j++){
		ctx.lineTo((ctx.canvas.width/2)+(outlines[i][j].X/scale*sf),(ctx.canvas.height/2)+(outlines[i][j].Y/scale*sf))
	}
	ctx.stroke()
}

ctx.fillStyle="#000"

//ctx.fillRect(20,20,5,5)

ctx.lineWidth="0.5"
ctx.strokeStyle="#ccc"

for(i=0;i<grid.length;i++){

	ctx.beginPath()
	for(j=0;j<grid[i].length;j++){
		ctx.lineTo((ctx.canvas.width/2)+(grid[i][j].X*sf),(ctx.canvas.height/2)+(grid[i][j].Y*sf))
	}
	ctx.stroke()
}

//console.log(pts)

ctx.lineWidth="0.2"
ctx.strokeStyle="#000"

for(i=0;i<pts.length;i++){
	ctx.beginPath()
	//ctx.arc(ctx.canvas.width/2+((pts[i].X)*sf),ctx.canvas.height/2+((pts[i].Y)*sf),0.1*sf,0,(Math.PI*2))
	ctx.stroke()
}

ctx.lineWidth=0.1*sf
ctx.strokeStyle="#333"

for(i=0;i<net.length;i++){
	ctx.beginPath()
	for(j=0;j<net[i].length;j++){
		//ctx.lineTo((ctx.canvas.width/2+(net[i][j].X*sf)),(ctx.canvas.height/2+(net[i][j].Y*sf)))
	}
	ctx.stroke()
}

//console.log(trace)

ctx.fillStyle="#777"

for(i=0;i<trace.length;i++){
	ctx.beginPath()
	for(j=0;j<trace[i].length;j++){
		ctx.lineTo((ctx.canvas.width/2+(trace[i][j].X*sf)),(ctx.canvas.height/2+(trace[i][j].Y*sf)))
	}
	ctx.fill()
	//ctx.stroke()
}

ctx.lineWidth="1"
ctx.strokeStyle="#ffff00"
ctx.fillStyle="#fff"

for(i=0;i<connect.length;i++){
	ctx.beginPath()
		ctx.arc(ctx.canvas.width/2+((connect[i].X)*sf),ctx.canvas.height/2+((connect[i].Y)*sf),0.2*sf,0,(Math.PI*2))
	ctx.fill()
	ctx.stroke()
}

//

ctx.beginPath()
	ctx.lineWidth="1"
	ctx.fillStyle = "yellow";
	ctx.strokeStyle="black"
	//ctx.arc(ctx.canvas.width/2,ctx.canvas.height/2,2,0,(Math.PI*2))
ctx.stroke()
ctx.fill()

	ctx.lineWidth="1"
	ctx.strokeStyle="#aaa"

for(i=0;i<arduino.length;i++){
	ctx.beginPath()
	//ctx.arc((ctx.canvas.width/2)+(arduino[i][0].X*sf),(ctx.canvas.height/2)+(arduino[i][0].Y*sf),((1.5)*sf),0,(Math.PI*2))

	for(j=0;j<arduino[i].length;j++){
		ctx.lineTo((ctx.canvas.width/2)+(arduino[i][j].X*sf),(ctx.canvas.height/2)+(arduino[i][j].Y*sf))
	}

	ctx.stroke()
}

	ctx.lineWidth="1"
	ctx.strokeStyle="blue"
	ctx.fillStyle="#fff"

for(i=0;i<arduino_pins.length;i++){
		ctx.beginPath()
	for(j=0;j<arduino_pins[i].length;j++){
		ctx.lineTo((ctx.canvas.width/2)+(arduino_pins[i][j].X*sf),(ctx.canvas.height/2)+(arduino_pins[i][j].Y*sf))
	}
	ctx.fill()
	ctx.stroke()

}


//ctx.setLineDash([1,1]);

ctx.fillStyle="#A020F0"

for(i=0;i<nodes.length;i++){
	ctx.beginPath()
	//ctx.arc(ctx.canvas.width/2+((nodes[i].X)*sf),ctx.canvas.height/2+((nodes[i].Y)*sf),1,0,(Math.PI*2))
	ctx.fill()
}

ctx.lineWidth="1"
ctx.strokeStyle="#000"

//console.log(path1)

//cutout path
ctx.beginPath()

	for(i=0;i<path1.length;i++){
		//ctx.lineTo(((path1[i].X*sf)+ctx.canvas.width/2).toFixed(2),((path1[i].Y*sf)+ctx.canvas.height/2).toFixed(2))

	}
ctx.stroke()

	for(i=0;i<vias.length;i++){
	ctx.beginPath()
		for(j=0;j<vias[i].length;j++){
			//ctx.lineTo(((vias[i][j].X*sf)+ctx.canvas.width/2).toFixed(2),((vias[i][j].Y*sf)+ctx.canvas.height/2).toFixed(2))
		}
	ctx.stroke()
	}

/*
ctx.beginPath()
	ctx.fillStyle = "#555";
	ctx.arc(ctx.canvas.width/2+((xmax-radius)*sf),ctx.canvas.height/2+((ymin+radius)*sf),2,0,(Math.PI*2))
ctx.fill()
*/

/*
ctx.beginPath()

	for(i=0;i<path1.length;i++){
		ctx.lineTo(((path1[i].X*sf)+ctx.canvas.width/2).toFixed(2),((path1[i].Y*sf)+ctx.canvas.height/2).toFixed(2))
	}
ctx.stroke()
*/

ctx.beginPath()
ctx.lineWidth="2"
ctx.strokeStyle="blue"

	for(i=0;i<frame1.length;i++){
		ctx.lineTo((frame1[i].X*sf)+ctx.canvas.width/2,(frame1[i].Y*sf)+ctx.canvas.height/2)
	}

ctx.stroke()
//

//	ctx.lineWidth=0.8*sf
//	ctx.strokeStyle="#ff00ff"

	ctx.lineWidth=0.6
	ctx.strokeStyle="#000"

	for(i=0;i<pins.length;i++){
		ctx.beginPath()
		for(j=0;j<pins[i].length;j++){
		ctx.lineTo((pins[i][j].X*sf)+ctx.canvas.width/2,(pins[i][j].Y*sf)+ctx.canvas.height/2)
		}
		ctx.stroke()
	}

ctx.lineWidth="1"
ctx.fillStyle="#fff"
ctx.strokeStyle="#333"

for(i=0;i<net.length;i++){
	for(j=0;j<net[i].length;j++){
		//console.log(Math.abs(net[i][j].Y))
		ctx.beginPath()
		if(((Math.abs(net[i][j].Y))<21)&&(net[i][j].D==true)){
		ctx.fillStyle="#fff"
		ctx.arc(ctx.canvas.width/2+((net[i][j].X)*sf),ctx.canvas.height/2+((net[i][j].Y)*sf),0.4*sf,0,(Math.PI*2))
		}
		else{
		ctx.fillStyle="#00ff00"
		//ctx.arc(ctx.canvas.width/2+((net[i][j].X)*sf),ctx.canvas.height/2+((net[i][j].Y)*sf),0.2*sf,0,(Math.PI*2))
		}
		ctx.fill()

	}
}

//ctx.setLineDash([4,4]);

ctx.strokeStyle="#ff00ff"
ctx.lineWidth="2"
for(i=0;i<paths.length;i++){
	ctx.beginPath()
	for(j=0;j<paths[i].length;j++){
		//console.log(paths[i][j].X)
		//ctx.lineTo((ctx.canvas.width/2+(paths[i][j].X*sf)),(ctx.canvas.height/2+(paths[i][j].Y*sf)))
	}
	ctx.stroke()
}

var size_font = (1.5*sf)

ctx.font = (size_font + "px Arial")
ctx.translate(ctx.canvas.width/2,ctx.canvas.height/2)

ctx.translate(((-11.45+o)*sf)+(1.5*sf),-27*sf)

ctx.rotate(-Math.PI/2);

ctx.fillStyle="#ff00ff"
ctx.fillText(" SCL",0,(-5.06*sf)-(sf));
ctx.fillText(" SDA",0,(-2.54*sf)-(sf));
ctx.fillText(" AREF",0,0-(sf));
ctx.fillText(" GND",0,(2.54*sf)-(sf));
ctx.fillText(" 13",0,(2.54*2*sf)-(sf));
ctx.fillText(" 12",0,(2.54*3*sf)-(sf));
ctx.fillText("~11",0,(2.54*4*sf)-(sf));
ctx.fillText("~10",0,(2.54*5*sf)-(sf));
ctx.fillText("  9",0,(2.54*6*sf)-(sf));
ctx.fillText("  8",0,(2.54*7*sf)-(sf));
ctx.fillText("  7",0,(2.54*8*sf)+(sf));
ctx.fillText("~6",0,(2.54*9*sf)+(sf));
ctx.fillText("~5",0,(2.54*10*sf)+(sf));
ctx.fillText("  4",0,(2.54*11*sf)+(sf));
ctx.fillText("~3",0,(2.54*12*sf)+(sf));
ctx.fillText("  2",0,(2.54*13*sf)+(sf));
ctx.fillText("  1 TX",0,(2.54*14*sf)+(sf));
ctx.fillText("  0 RX",0,(2.54*15*sf)+(sf));

ctx.fillText("A5",(-56*sf),(2.54*15*sf)+(sf));
ctx.fillText("A4",(-56*sf),(2.54*14*sf)+(sf));
ctx.fillText("A3",(-56*sf),(2.54*13*sf)+(sf));
ctx.fillText("A2",(-56*sf),(2.54*12*sf)+(sf));
ctx.fillText("A1",(-56*sf),(2.54*11*sf)+(sf));
ctx.fillText("A0",(-56*sf),(2.54*10*sf)+(sf));

ctx.fillText("VIN",(-56.5*sf),(2.54*9*sf)-(1.5*sf));
ctx.fillText("GND",(-57.3*sf),(2.54*8*sf)-(1.5*sf));
ctx.fillText("GND",(-57.3*sf),(2.54*7*sf)-(1.5*sf));
ctx.fillText("5V",(-56*sf),(2.54*6*sf)-(1.5*sf));
ctx.fillText("3.3V",(-57.3*sf),(2.54*5*sf)-(1.5*sf));
ctx.fillText("RST",(-57.2*sf),(2.54*4*sf)-(1.5*sf));
ctx.fillText("IOREF",(-58.5*sf),(2.54*3*sf)-(1.5*sf));
ctx.fillText("NC",(-56.5*sf),(2.54*2*sf)-(1.5*sf));
}


$("#myCanvas").bind('click', function(e) {

	if((document.getElementById('action').value=='route') || (document.getElementById('action').value=='resistor')){



	x = ((e.clientX-(10)-(ctx.canvas.width/2))/sf)
	y = ((e.clientY-(10)-(ctx.canvas.height/2))/sf)

	if(document.getElementById('action').value=='resistor'){
		pin++
		if(pin==3){
			pin=1
		}
	}

		var d = 0.3
		var r = 0.85
		var v = 100
		var drill = false
		if(document.getElementById("type").value=="dip"){
			drill=true
		}

		for(i=0;i<pts.length;i++){
	
			if(((Math.abs(x-pts[i].X))<=0.635) && ((Math.abs(y-pts[i].Y))<=0.635)){
				if((document.getElementById('action').value=='route')&&((net[net.length-1].length)==0)){
					net[net.length-1].push({X:(pts[i].X),Y:(pts[i].Y),D:drill})

						trace.push([])
						
						if(document.getElementById("type").value=="dip"){
							for(j=0;j<=v;j++){
								trace[trace.length-1].push({X:((pts[i].X)+Math.sin((Math.PI*2)/v*j)*r),Y:((pts[i].Y)+Math.cos((Math.PI*2)/v*j)*r)})
							}
						}
						else if(document.getElementById("type").value=="smd"){
							trace[trace.length-1].push({X:pts[i].X-r,Y:pts[i].Y-r})
							trace[trace.length-1].push({X:pts[i].X-r,Y:pts[i].Y+r})
							trace[trace.length-1].push({X:pts[i].X+r,Y:pts[i].Y+r})
							trace[trace.length-1].push({X:pts[i].X+r,Y:pts[i].Y-r})
							trace[trace.length-1].push({X:pts[i].X-r,Y:pts[i].Y-r})
						}	

				}
				else if((pts[i].X==net[net.length-1][net[net.length-1].length-1].X) && (pts[i].Y==net[net.length-1][net[net.length-1].length-1].Y)){

				//skip

				}
				else if((document.getElementById('action').value=='route')&&((net[net.length-1].length)>0)){

							var Ax = net[net.length-1][net[net.length-1].length-1].X
							var Ay = net[net.length-1][net[net.length-1].length-1].Y
							var Bx = pts[i].X
							var By = pts[i].Y		

							var ABx =  Bx - Ax
							var ABy =  By - Ay

							var ABLength = Math.sqrt(ABx*ABx + ABy*ABy)

							var NABx = ABx / ABLength
							var NABy = ABy / ABLength

							var PNABx = -NABy
							var PNABy =  NABx
							
							

							var Dx = Ax + ((d)*PNABx)
							var Dy = Ay + ((d)*PNABy)
	
							var Cx = Ax + (-(d)*PNABx)
							var Cy = Ay + (-(d)*PNABy)

							var Ex = Bx + ((d)*PNABx)
							var Ey = By + ((d)*PNABy)
	
							var Fx = Bx + (-(d)*PNABx)
							var Fy = By + (-(d)*PNABy)
					
					trace.push([{X:Cx,Y:Cy},{X:Dx,Y:Dy},{X:Ex,Y:Ey},{X:Fx,Y:Fy},{X:Cx,Y:Cy}])

					trace.push([])
						if(document.getElementById("type").value=="dip"){
							for(j=0;j<=v;j++){
								trace[trace.length-1].push({X:((pts[i].X)+Math.sin((Math.PI*2)/v*j)*r),Y:((pts[i].Y)+Math.cos((Math.PI*2)/v*j)*r)})
							}
						}
						else if(document.getElementById("type").value=="smd"){
							trace[trace.length-1].push({X:pts[i].X-r,Y:pts[i].Y-r})
							trace[trace.length-1].push({X:pts[i].X-r,Y:pts[i].Y+r})
							trace[trace.length-1].push({X:pts[i].X+r,Y:pts[i].Y+r})
							trace[trace.length-1].push({X:pts[i].X+r,Y:pts[i].Y-r})
							trace[trace.length-1].push({X:pts[i].X-r,Y:pts[i].Y-r})		
						}					

					net[net.length-1].push({X:(pts[i].X),Y:(pts[i].Y),D:drill})

					//add_trace()
					
					if( (Math.abs((pts[i].X)-(net[net.length-1][net[net.length-1].length-1].X))) < (Math.abs((pts[i].Y)-(net[net.length-1][net[net.length-1].length-1].Y))) ){
						//net[net.length-1].push({X:(pts[i].X),Y:(net[net.length-1][net[net.length-1].length-1].Y)})
						//net[net.length-1].push({X:(net[net.length-1][net[net.length-1].length-1].X),Y:(pts[i].Y)})

					}
					else{
						//net[net.length-1].push({X:(net[net.length-1][net[net.length-1].length-1].X),Y:(pts[i].Y)})
						//net[net.length-1].push({X:(pts[i].X),Y:(net[net.length-1][net[net.length-1].length-1].Y)})

					}
					}
				}
				else if((document.getElementById('action').value=='resistor')&&(pin==1)){

					//net[net.length-1].push({X:(pts[i].X),Y:(pts[i].Y)})
					
					if( (Math.abs((pts[i].X)-(net[net.length-1][net[net.length-1].length-1].X))) < (Math.abs((pts[i].Y)-(net[net.length-1][net[net.length-1].length-1].Y))) ){
						//net[net.length-1].push({X:(pts[i].X),Y:(net[net.length-1][net[net.length-1].length-1].Y)})
						net[net.length-1].push({X:(net[net.length-1][net[net.length-1].length-1].X),Y:(pts[i].Y)})
					}
					else{
						//net[net.length-1].push({X:(net[net.length-1][net[net.length-1].length-1].X),Y:(pts[i].Y)})
						net[net.length-1].push({X:(pts[i].X),Y:(net[net.length-1][net[net.length-1].length-1].Y)})
					}
				}
				else if((document.getElementById('action').value=='resistor')&&(pin==2)){


				}
			
		}


	}

	else if(document.getElementById('action').value=='undo'){
		if(net.length>0){
		net[net.length-1].pop()
		}
	}

	else if(document.getElementById('action').value=='clear'){
		net=[[]]
	}
	else if(document.getElementById('action').value=='end'){
		net.push([])
	}
	//route()
	if(seg==1){
		net.push([])	
		seg = 0
	}
	else{
		seg++
	}
	
	//console.log(trace)

	add_trace()

	//draw()
	

});


function undo(){

console.log(net)

if(net.length>0)
{
	if(net[net.length-1].length==0){
		net.pop()
		if(net.length==0){
			net = [[]]
		}
	}
	if(net[net.length-1].length==2){
		net[net.length-1].pop()
		if(net.length==0){
			net = [[]]
		}
	}
	else{
		net[net.length-1].pop()
	}
}
else{
	net = [[]]
}

if(seg==1){
	trace.pop()
	seg--
}
else{
	trace.pop()
	trace.pop()
	seg=1
}

add_trace()

}


$("#myCanvas").bind('mousemove', function(e) {


});

function makeFrame(radius) {

frame1=[]
path1=[]

for (i=0;i<=verts;i++) {
   if(i<=25){
      frame1.push({X:((xmax-radius)+Math.sin((Math.PI*2)/verts*i)*radius),Y:((ymax-radius)+Math.cos((Math.PI*2)/verts*i)*radius)})
      
      path1.push({X:((xmax-radius)+Math.sin((Math.PI*2)/verts*i)*(radius+tool)),Y:((ymax-radius)+Math.cos((Math.PI*2)/verts*i)*(radius+tool))})
   }
   else if((i>25)&&(i<=50)){
      frame1.push({X:((xmax-radius)+Math.sin((Math.PI*2)/verts*i)*radius),Y:((ymin+radius)+Math.cos((Math.PI*2)/verts*i)*radius)})
      
      path1.push({X:((xmax-radius)+Math.sin((Math.PI*2)/verts*i)*(radius+tool)),Y:((ymin+radius)+Math.cos((Math.PI*2)/verts*i)*(radius+tool))}) 
   }
   else if((i>50)&&(i<=75)){
      frame1.push({X:((xmin+radius)+Math.sin((Math.PI*2)/verts*i)*radius),Y:((ymin+radius)+Math.cos((Math.PI*2)/verts*i)*radius)})
      
      path1.push({X:((xmin+radius)+Math.sin((Math.PI*2)/verts*i)*(radius+tool)),Y:((ymin+radius)+Math.cos((Math.PI*2)/verts*i)*(radius+tool))})     
   }
   else if((i>75)&&(i<=100)){
      frame1.push({X:((xmin+radius)+Math.sin((Math.PI*2)/verts*i)*radius),Y:((ymax-radius)+Math.cos((Math.PI*2)/verts*i)*radius)})
      
      path1.push({X:((xmin+radius)+Math.sin((Math.PI*2)/verts*i)*(radius+tool)),Y:((ymax-radius)+Math.cos((Math.PI*2)/verts*i)*(radius+tool))})  
           
      if(i==100){
      frame1.push(frame1[0])
      path1.push(path1[0])
      }      
   }   
}


if(radius==0){
	frame1=[]
	frame1.push({X:xmax,Y:ymax})
	frame1.push({X:xmax,Y:ymin})
	frame1.push({X:xmin,Y:ymin})
	frame1.push({X:xmin,Y:ymax})
	frame1.push({X:xmax,Y:ymax})
}

else if(radius+tool<=0){
	path1=[]
	path1.push({X:-xmax-tool,Y:-ymax-tool})
	path1.push({X:-xmax-tool,Y:-ymin+tool})
	path1.push({X:-xmin+tool,Y:-ymin+tool})
	path1.push({X:-xmin+tool,Y:-ymax-tool})
	path1.push({X:-xmax-tool,Y:-ymax-tool})
}

	frame1.reverse()
	draw()
}


function parts(){

	o = -5

	arduino.push( [{X:-34+o,Y:-26.5},{X:31+o,Y:-26.5},{X:31+o,Y:-13.5},{X:34+o,Y:-10.5},{X:34+o,Y:21.5},{X:31+o,Y:24.5},{X:31+o,Y:26.5},{X:-34+o,Y:26.5},{X:-34+o,Y:22.5}] )

	arduino.push([])
	for(i=0;i<=25;i++){
		//arduino[1].push({X:((-18)+Math.sin((Math.PI*2)/25*i)*1.5)+o,Y:((-24)+Math.cos((Math.PI*2)/25*i)*1.5)})
	}

	arduino.push([])
	for(i=0;i<=25;i++){
		//arduino[2].push({X:((31.5)+Math.sin((Math.PI*2)/25*i)*1.5)+o,Y:((19.5)+Math.cos((Math.PI*2)/25*i)*1.5)})
	}

	arduino.push([])
	for(i=0;i<=25;i++){
		//arduino[3].push({X:((31.5)+Math.sin((Math.PI*2)/25*i)*1.5)+o,Y:((-8.5)+Math.cos((Math.PI*2)/25*i)*1.5)})
	}

	arduino.push([])
	for(i=0;i<=25;i++){
		//arduino[4].push({X:((-19)+Math.sin((Math.PI*2)/25*i)*1.5)+o,Y:((24)+Math.cos((Math.PI*2)/25*i)*1.5)})
	}

	arduino.push( [{X:-34+o,Y:13.5},{X:-34+o,Y:-5.5}] )
	arduino.push( [{X:-34+o,Y:-17.5},{X:-34+o,Y:-26.5}] )
	arduino.push( [{X:-40+o,Y:-17.5},{X:-23+o,Y:-17.5},{X:-23+o,Y:-5.5},{X:-40+o,Y:-5.5},{X:-40+o,Y:-17.5}] )
	arduino.push( [{X:-35+o,Y:13.5},{X:-22+o,Y:13.5},{X:-22+o,Y:22.5},{X:-35+o,Y:22.5},{X:-35+o,Y:13.5}] )

	x=0
	y=0
	for(i=0;i<35;i++){
		x=0
	for(j=0;j<40;j++){
		pts.push({X:-19.685+o+x,Y:21.59+y})
		x = x+1.27
	}
		y = y-1.27
	}

	y = 0
	for(i=0;i<41;i++){
		grid.push([{X:-19.685+o,Y:25.4-y},{X:29.77+o,Y:25.4-y}])
		//grid.push([{X:-16.51+o,Y:22.86-y},{X:29.77+o,Y:22.86-y}])
		//y = y + 0.3175
		y = y + 1.27
	}
	x = 0
	for(i=0;i<40;i++){
		grid.push([{X:-19.685+o+x,Y:25.4},{X:-19.685+o+x,Y:-25.4}])
		//grid.push([{X:-16.51+o+x,Y:22.86},{X:-16.51+o+x,Y:-22.86}])
		//x = x + 0.3175
		x = x + 1.27
	}

	x = 7.6+1.27
	//arduino.push([{X:(x+o),Y:-25.135},{X:(x+o),Y:-22.86},{X:(x+o)-25.38,Y:-22.86},{X:(x+o)-25.38,Y:-25.135},{X:(x+o),Y:-25.135}])
	
	x = 28.5+1.27
	//arduino.push([{X:(x+o),Y:-25.135},{X:(x+o),Y:-22.86},{X:(x+o)-20.32,Y:-22.86},{X:(x+o)-20.32,Y:-25.135},{X:(x+o),Y:-25.135}])
		
	x = 28.5+1.27
	//arduino.push([{X:(x+o),Y:25.135},{X:(x+o),Y:22.86},{X:(x+o)-15.24,Y:22.86},{X:(x+o)-15.24,Y:25.135},{X:(x+o),Y:25.135}])

	x = 11.7+1.27
	//arduino.push([{X:(x+o),Y:25.135},{X:(x+o),Y:22.86},{X:(x+o)-20.3,Y:22.86},{X:(x+o)-20.3,Y:25.135},{X:(x+o),Y:25.135}])


	//top pins
	x = -17.8

	pin_outlines.push([{X:(x+o+0.635+0.4),Y:-20.32-0.4},{X:(x+o+0.635+0.4),Y:-22.86},{X:(x+o),Y:-22.86},{X:(x+o),Y:-25.4+0.4},{X:(x+o+2.54)+(2.54*9)-0.4,Y:-25.4+0.4},{X:(x+o+2.54)+(2.54*9)-0.4,Y:-22.86},{X:(x+o+3.175)+(2.54*9)-0.4,Y:-22.86},{X:(x+o+3.175)+(2.54*9)-0.4,Y:-20.32-0.4},{X:(x+o+0.635),Y:-20.32-0.4}])

	//pins.push([{X:(x+o+0.635),Y:-20.32},{X:(x+o+0.635),Y:-22.86},{X:(x+o),Y:-22.86},{X:(x+o),Y:-25.4},{X:(x+o+2.54)+(2.54*9),Y:-25.4},{X:(x+o+2.54)+(2.54*9),Y:-22.86},{X:(x+o+3.175)+(2.54*9),Y:-22.86},{X:(x+o+3.175)+(2.54*9),Y:-20.32}])

	x = x + 2.54	

	for(i=0;i<9;i++){
		pins.push([{X:(x+o+0.635),Y:-20.32},{X:(x+o+0.635),Y:-22.86},{X:(x+o),Y:-22.86},{X:(x+o),Y:-25.4}])
	x = x + 2.54
	}

	x = 9.505
	
	pin_outlines.push([{X:(x+o+0.4),Y:-20.32-0.4},{X:(x+o+0.4),Y:-25.4+0.4},{X:(x+o+2.54*8-0.4),Y:-25.4+0.4},{X:(x+o+2.54*8-0.4),Y:-20.32-0.4},{X:(x+o),Y:-20.32-0.4}])

	//pins.push([{X:(x+o),Y:-20.32},{X:(x+o),Y:-25.4},{X:(x+o+2.54*8),Y:-25.4},{X:(x+o+2.54*8),Y:-20.32}])
	x = x + 2.54
	for(i=0;i<7;i++){
		pins.push([{X:(x+o),Y:-20.32},{X:(x+o),Y:-25.4}])
	x = x + 2.54
	}
	
	//bottom pins

	x = 29.825

	pin_outlines.push([{X:(x+o),Y:20.32+0.4},{X:(x+o),Y:25.4-0.4},{X:(x+o-2.54*6),Y:25.4-0.4},{X:(x+o-2.54*6),Y:20.32+0.4},{X:(x+o),Y:20.32+0.4}])

	//pins.push([{X:(x+o),Y:20.32},{X:(x+o),Y:25.4},{X:(x+o-2.54*6),Y:25.4},{X:(x+o-2.54*6),Y:20.32}])
	x = x - 2.54
	for(i=0;i<5;i++){
		pins.push([{X:(x+o),Y:20.32},{X:(x+o),Y:25.4}])
	x = x - 2.54
	}

	x = 12.06

	pin_outlines.push([{X:(x+o),Y:20.32+0.4},{X:(x+o),Y:25.4-0.4},{X:(x+o-2.54*8),Y:25.4-0.4},{X:(x+o-2.54*8),Y:20.32+0.4},{X:(x+o),Y:20.32+0.4}])


	//pin_outlines.push([{X:(x+o-2.54*7),Y:20.32+0.4},{X:(x+o),Y:20.32+0.4},{X:(x+o),Y:25.4-0.4},{X:(x+o-2.54*7),Y:25.4-0.4},{X:(x+o-2.54*8),Y:25.4-0.4},{X:(x+o-2.54*8),Y:22.86},{X:(x+o-2.54*7),Y:22.86},{X:(x+o-2.54*7),Y:20.32+0.4}])

	//pins.push([{X:(x+o),Y:20.32},{X:(x+o),Y:25.4},{X:(x+o-2.54*7),Y:25.4},{X:(x+o-2.54*8),Y:25.4},{X:(x+o-2.54*8),Y:22.86},{X:(x+o-2.54*7),Y:22.86}])

	x = x - 2.54
	for(i=0;i<7;i++){
		if(i==7){
		pins.push([{X:(x+o),Y:22.86},{X:(x+o),Y:25.4},{X:(x+o-2.54),Y:25.4},{X:(x+o-2.54),Y:22.86},{X:(x+o),Y:22.86}])
		}
		else{
		pins.push([{X:(x+o),Y:20.32},{X:(x+o),Y:25.4}])
		}
	x = x - 2.54
	}

	//name pins

	for(i=0;i<pins.length;i++){
	if(i==0){
		pins[i].name='scl'
	}
	else if(i==1){
		pins[i].name='sda'
	}
	else if(i==2){
		pins[i].name='aref'
	}
	else if(i==3){
		pins[i].name='gnd'
	}
	else if(i==4){
		pins[i].name='13'
	}
	else if(i==5){
		pins[i].name='12'
	}
	else if(i==6){
		pins[i].name='11'
	}
	else if(i==7){
		pins[i].name='10'
	}
	else if(i==8){
		pins[i].name='9'
	}
	else if(i==9){
		pins[i].name='8'
	}
	else if(i==10){
		pins[i].name='7'
	}
	else if(i==11){
		pins[i].name='6'
	}
	else if(i==12){
		pins[i].name='5'
	}
	else if(i==13){
		pins[i].name='4'
	}
	else if(i==14){
		pins[i].name='3'
	}
	else if(i==15){
		pins[i].name='2'
	}
	else if(i==16){
		pins[i].name='1'
	}
	else if(i==17){
		pins[i].name='0'
	}
	else if(i==18){
		pins[i].name='a5'
	}
	else if(i==19){
		pins[i].name='a4'
	}
	else if(i==20){
		pins[i].name='a3'
	}
	else if(i==21){
		pins[i].name='a2'
	}
	else if(i==22){
		pins[i].name='a1'
	}
	else if(i==23){
		pins[i].name='a0'
	}
	else if(i==24){
		pins[i].name='vin'
	}
	else if(i==25){
		pins[i].name='gnd2'
	}
	else if(i==26){
		pins[i].name='gnd3'
	}
	else if(i==27){
		pins[i].name='5v'
	}
	else if(i==28){
		pins[i].name='3.3v'
	}
	else if(i==29){
		pins[i].name='rst'
	}
	else if(i==30){
		pins[i].name='ioref'
	}
	else if(i==31){
		pins[i].name='nc'
	}

	}

x=-15.95
for(i=0;i<10;i++){
	connect.push({X:(x+o),Y:(-21.59)})
	x = x +2.54
}

x=10.72
for(i=10;i<18;i++){
	connect.push({X:(x+o),Y:(-21.59)})
	x = x +2.54
}


x=28.5
for(i=18;i<24;i++){
	connect.push({X:(x+o),Y:(21.59)})
	x = x -2.54
}

x=10.72
for(i=24;i<31;i++){
	connect.push({X:(x+o),Y:(21.59)})
	x = x -2.54
}

	//

	x = 7.6+1.27

	for(i=0;i<10;i++){
		//pin_outlines.push([{X:(x+o),Y:-25.135},{X:(x+o),Y:-22.86}])
		x = x -2.54
	}
	
	x = 28.5+1.27
	for(i=0;i<8;i++){
		//pin_outlines.push([{X:(x+o),Y:-25.135},{X:(x+o),Y:-22.86}])
		x = x -2.54
	}
	

	x = 28.5+1.27
	for(i=0;i<6;i++){
		//pin_outlines.push([{X:(x+o),Y:25.135},{X:(x+o),Y:22.86}])
		x = x -2.54
	}

	x = 11.7+1.27
	for(i=0;i<8;i++){
		//pin_outlines.push([{X:(x+o),Y:25.135},{X:(x+o),Y:22.86}])
		x = x -2.54
	}

	var x = 28.5
	for(i=0;i<8;i++){
		arduino_pins.push([])
		vias.push([])
			nodes.push({X:(x+o),Y:(-24)})
			for(j=0;j<=25;j++){
				arduino_pins[i].push({X:((x+o)+Math.sin((Math.PI*2)/25*j)*0.5),Y:((-24)+Math.cos((Math.PI*2)/25*j)*0.5)})
				vias[i].push({X:((x+o)+Math.sin((Math.PI*2)/25*j)*0.2),Y:((-24)+Math.cos((Math.PI*2)/25*j)*0.2)})
			}
		x = x -2.54
	}

	x = 6.34
	for(i=8;i<18;i++){
		arduino_pins.push([])
		vias.push([])
		//nodes.push({X:(x+o+0.635),Y:(-21.73)})
		nodes.push({X:(x+o),Y:(-24)})
			for(j=0;j<=25;j++){
				arduino_pins[i].push({X:((x+o)+Math.sin((Math.PI*2)/25*j)*0.5),Y:((-24)+Math.cos((Math.PI*2)/25*j)*0.5)})
				vias[i].push({X:((x+o)+Math.sin((Math.PI*2)/25*j)*0.2),Y:((-24)+Math.cos((Math.PI*2)/25*j)*0.2)})
			}
		x = x -2.54
	}

	var x = 28.5
	for(i=18;i<24;i++){
		arduino_pins.push([])
		vias.push([])
		//nodes.push({X:(x+o),Y:(21.73)})
			nodes.push({X:(x+o),Y:(24)})
			for(j=0;j<=25;j++){
				arduino_pins[i].push({X:((x+o)+Math.sin((Math.PI*2)/25*j)*0.5),Y:((24)+Math.cos((Math.PI*2)/25*j)*0.5)})
				vias[i].push({X:((x+o)+Math.sin((Math.PI*2)/25*j)*0.2),Y:((24)+Math.cos((Math.PI*2)/25*j)*0.2)})
			}
		x = x -2.54
	}

	var x = 10.72
	for(i=24;i<32;i++){
		arduino_pins.push([])
		vias.push([])
		//nodes.push({X:(x+o-0.79375),Y:(21.73)})
			nodes.push({X:(x+o),Y:(24)})
			for(j=0;j<=25;j++){
				arduino_pins[i].push({X:((x+o)+Math.sin((Math.PI*2)/25*j)*0.5),Y:((24)+Math.cos((Math.PI*2)/25*j)*0.5)})
				vias[i].push({X:((x+o)+Math.sin((Math.PI*2)/25*j)*0.2),Y:((24)+Math.cos((Math.PI*2)/25*j)*0.2)})
			}
		x = x -2.54
	}

draw()
route()

}

function add_trace(){

var traces = []

for(i=0;i<pin_outlines.length;i++){
	traces.push([])
	for(j=0;j<pin_outlines[i].length;j++){
		traces[traces.length-1].push({X:parseInt(pin_outlines[i][j].X*scale),Y:parseInt(pin_outlines[i][j].Y*scale)})
	}
}

for(i=0;i<trace.length;i++){
	traces.push([])
	for(j=0;j<trace[i].length;j++){
		traces[traces.length-1].push({X:parseInt(trace[i][j].X*scale),Y:parseInt(trace[i][j].Y*scale)})
	}
}
//console.log(traces)

var cpr = new ClipperLib.Clipper()
cpr.AddPaths(traces, ClipperLib.PolyType.ptSubject, true)

var solution_paths = new ClipperLib.Paths();
cpr.Execute(ClipperLib.ClipType.ctUnion, solution_paths, ClipperLib.PolyFillType.pftNonZero, ClipperLib.PolyFillType.pftNonZero);

for(i=0;i<solution_paths.length;i++){
		solution_paths[i].reverse()
		solution_paths[i].push(solution_paths[i][0])
}

solution_paths.push([])
for(i=0;i<frame1.length;i++){
	solution_paths[solution_paths.length-1].push({X:parseInt(frame1[i].X*scale),Y:parseInt(frame1[i].Y*scale)})
}


//offset

var co = new ClipperLib.ClipperOffset(scale*0.4, 0.25)
//co.ArcTolerance = 1.23
//co.MiterLimit = 1.6
co.AddPaths(solution_paths, ClipperLib.JoinType.jtMiter, ClipperLib.EndType.etClosedPolygon, 0.25)
offset = new ClipperLib.Paths()
co.Execute(offset, -scale*0.4)

for(i=0;i<offset.length;i++){
		offset[i].push(offset[i][0])
}
	outlines = offset
//

for(i=0;i<solution_paths.length;i++){
	for(j=0;j<solution_paths[i].length;j++){
		solution_paths[i][j]=({X:solution_paths[i][j].X/scale,Y:solution_paths[i][j].Y/scale})
	}
		//solution_paths[i].push(solution_paths[i][0])
}

//console.log(solution_paths)

paths = solution_paths

draw()


}


function route(){


for(i=0;i<frame1.length;i++){
	//console.log(outlines[i][j].X*scale)
	outlines.push({X:parseInt(frame1[i].X*scale),Y:parseInt(frame1[i].Y*scale)})
}

	outlines = [outlines]
	

for(i=0;i<pin_outlines.length;i++){
	outlines.push([])
	pin_outlines[i].reverse()
	for(j=0;j<pin_outlines[i].length;j++){
		outlines[outlines.length-1].push({X:parseInt(pin_outlines[i][j].X*scale),Y:parseInt(pin_outlines[i][j].Y*scale)})
	}
}

//outlines = ClipperLib.Clipper.SimplifyPolygons(outlines, ClipperLib.PolyFillType.pftNonZero)

var co = new ClipperLib.ClipperOffset(-scale*0.4, 0.25)
co.AddPaths(outlines, ClipperLib.JoinType.jtMiter, ClipperLib.EndType.etClosedPolygon)
offset = new ClipperLib.Paths()
co.Execute(offset, -scale*0.4)

for(i=0;i<offset.length;i++){
		offset[i].push(offset[i][0])
}


//console.log(offset)
//outlines = offset
//console.log(outlines)

add_trace()
//draw()

}


$("#input_width").on("change", function(){
	 xmax = parseFloat(document.getElementById("input_width").value)
	 if(isNaN(xmax)==true){
    	xmax=radius*2
    	document.getElementById('input_width').value=(xmax)
    }
    else if(xmax<radius*2){
	 	xmax=radius*2
	 	document.getElementById('input_width').value=(xmax).toFixed(1)
	 }
    else if(xmax<0.1){
	 	xmax=Math.abs(xmax)
	 	document.getElementById('input_width').value=(xmax).toFixed(1)
	 }
    xmax=(xmax/2).toFixed(3)	 
	 xmin = -xmax
	 //setAppConfig
	 myConfig.Xmin=xmin
	 myConfig.Xmax=xmax
    //fabmo.setAppConfig(myConfig)

    makeFrame(radius)
})

$("#input_height").on("change", function(){
	 ymax = parseFloat(document.getElementById("input_height").value)
	 if(isNaN(ymax)==true){
    	ymax=radius*2
    	document.getElementById('input_height').value=(ymax)
    }
    else if(ymax<radius*2){
	 	ymax=radius*2
	 	document.getElementById('input_height').value=(ymax).toFixed(1)
	 }
	 else if(ymax<0.1){
	 	ymax=Math.abs(ymax)
	 	document.getElementById('input_height').value=(ymax).toFixed(1)
	 }
    ymax=(ymax/2).toFixed(3) 
	 ymin = -ymax
	 myConfig.Ymin=ymin
	 myConfig.Ymax=ymax
    //fabmo.setAppConfig(myConfig)
    makeFrame(radius)
})

$("#input_radius").on("change", function(){
	 radius = parseFloat(document.getElementById("input_radius").value)
    if(isNaN(radius)==true){
    	radius=5
    	document.getElementById('input_radius').value=radius
    } 
	 else if(radius<0){
	 	radius=Math.abs(radius)
	 	document.getElementById('input_radius').value=radius.toFixed(1)
	 }
	 
	 if(radius>xmax){
	 	radius=xmax
	   document.getElementById('input_radius').value=radius.toFixed(1)
	 }
	 else if(radius>ymax){
	 	radius=ymax
	   document.getElementById('input_radius').value=radius.toFixed(1)
	 }
	 //setAppConfig
	 myConfig.radius=radius
    //fabmo.setAppConfig(myConfig)

    makeFrame(radius)
})

$("#input_tool").on("change", function(){
	 tool=parseFloat(document.getElementById("input_tool").value)
	 if(isNaN(tool)==true){
    	tool=0
    	document.getElementById('input_tool').value=tool
    }
    else{
    	tool=(tool/2)
    }
    
    if(tool<xmin){    
    	tool=xmin
    	document.getElementById('input_tool').value=tool*2    	   
    }
    else if(tool<ymin){    
    	tool=ymin
    	document.getElementById('input_tool').value=tool*2  	   
    }
	 //setAppConfig
	 myConfig.tool=tool
    //fabmo.setAppConfig(myConfig)

    makeFrame(radius)
})


$("#input_depth").on("change", function(){

	 myConfig.depth=document.getElementById('input_depth').value
    fabmo.setAppConfig(myConfig)

})

function loadConfig(){

fabmo.getAppConfig(function(err, myConfig) {

if(typeof myConfig.Xmin != 'undefined'){
	xmin = myConfig.Xmin
}

if(typeof myConfig.Xmax != 'undefined'){
	xmax = myConfig.Xmax
}

if(typeof myConfig.Ymin != 'undefined'){
	ymin = myConfig.Ymin
}

if(typeof myConfig.Ymax != 'undefined'){
	ymax = myConfig.Ymax
}

if(typeof myConfig.radius != 'undefined'){
	radius = myConfig.radius
}

if(typeof myConfig.tool != 'undefined'){
	tool = myConfig.tool
}

if(typeof myConfig.depth != 'undefined'){
	document.getElementById('input_depth').value = myConfig.depth
}

document.getElementById('input_tool').value = tool*2
document.getElementById('input_radius').value = radius
document.getElementById('input_width').value = xmax*2
document.getElementById('input_height').value = ymax*2

makeFrame(radius)

});

}

$(window).resize(function(){

	draw()
}); 




function make(){

var material = {feed:250,plunge:200}
var pass_depth = 0.425

var filetype = "sbp"

/*
g="(coming soon!)\n"

fabmo.submitJob({
   file : g,
   filename : 'mill.g',
   name : "MILL TRACES 1/64",
   description : (xmax*2) + " x " + (ymax*2) + " x " + "mm" 
});
*/

g=""

	pins.reverse()


//flip (smd)

   for(i=0;i<outlines.length;i++){
		for(j=0;j<outlines[i].length;j++){
			if((outlines[i][j].Y)<0){
				console.log(j)
				outlines[i][j]={X:outlines[i][j].X,Y:(Math.abs(outlines[i][j].Y))}
			}
			else{
				outlines[i][j]={X:outlines[i][j].X,Y:(0-(outlines[i][j].Y))}	
			}
		}
	}


   for(i=0;i<pins.length;i++){
		for(j=0;j<pins[i].length;j++){
			if(pins[i][j].Y<0){
				pins[i][j].Y=Math.abs(pins[i][j].Y)
			}
			else{
				pins[i][j].Y=(0-pins[i][j].Y)	
			}
		}
	}

   for(i=0;i<vias.length;i++){
		for(j=0;j<vias[i].length;j++){
			if(vias[i][j].Y<0){
				vias[i][j].Y=Math.abs(vias[i][j].Y)
			}
			else{
				vias[i][j].Y=(0-vias[i][j].Y)	
			}
		}
	}

//


if(filetype=="gcode"){
/////////////////////////////gcode
g+="g21\n"
g+="g0z5\n"
g+="m4\n"
g+="g4p2\n" 



//drill connect holes
/*
   for(i=0;i<connect.length;i++){

		pass_no = 5
		pass = 1
		g+="g0x"+(connect[i].X.toFixed(3))+"y"+ (connect[i].Y).toFixed(3) + "\n"

		while(pass<=pass_no){
	   	g+="g1z-"+ (pass_depth*pass) + "f" + material.plunge + "\n"
			g+="g0z1\n"
			pass++
		}
		
	}
*/
  

   for(i=0;i<vias.length;i++){

		pass_no = 4
		pass = 1
		g+="g0x"+(vias[i][0].X.toFixed(3))+"y"+ (vias[i][0].Y).toFixed(3) + "\n"

		while(pass<=pass_no){
	   g+="g1z-"+ (pass_depth*pass) + "f" + material.plunge + "\n"
	   g+="g1f" + material.feed + "\n"
			for(j=0;j<vias[i].length;j++){
   	   	g+="g1x"+(vias[i][j].X).toFixed(3) +"y"+ (vias[i][j].Y).toFixed(3) + "\n"
			}
		pass++
   	}
		g+="g0z2\n"
	}

   for(i=0;i<pins.length;i++){
		g+="g0x"+(pins[i][0].X.toFixed(3))+"y"+ (pins[i][0].Y).toFixed(3) + "\n"
	   g+="g1z-"+ (0.2) + "f" + material.plunge + "\n"
	   g+="g1f" + material.feed + "\n"
			for(j=1;j<pins[i].length;j++){
				g+="g1x"+(pins[i][j].X.toFixed(3))+"y"+ (pins[i][j].Y).toFixed(3) + "\n"		
			}
		g+="g0z2\n"
	}

	//drill vias

   for(i=0;i<net.length;i++){
		
   	for(j=0;j<net[i].length;j++){
		pass_no = 5
		pass = 1
		if(((Math.abs(net[i][j].Y))<21)&&(net[i][j].D==true)){
			g+="g0x"+(net[i][j].X.toFixed(3))+"y"+ (net[i][j].Y).toFixed(3) + "\n"
				while(pass<=pass_no){
	   			g+="g1z-"+ (pass_depth*pass) + "f" + material.plunge + "\n"
					g+="g0z1\n"
					pass++
				}
			g+="g0z2\n"
		}
		}
	}
	
	//

	outlines.reverse()

   for(i=0;i<outlines.length;i++){
		g+="g0x"+(outlines[i][0].X/scale.toFixed(3))+"y"+ (outlines[i][0].Y/scale).toFixed(3) + "\n"
	   g+="g1z-"+ (0.2) + "f" + material.plunge + "\n"
	   g+="g1f" + material.feed + "\n"
			for(j=1;j<outlines[i].length;j++){
				g+="g1x"+(outlines[i][j].X/scale.toFixed(3))+"y"+ (outlines[i][j].Y/scale).toFixed(3) + "\n"		
			}
		g+="g0z2\n"
	}

pass_no = 4
pass = 1


g+="g0z2\n"

path1.reverse()
path1[0]={X:0,Y:parseFloat(ymax+tool)}
path1.push(path1[0])

g+="g0x"+(path1[0].X.toFixed(3))+"y"+ (path1[0].Y).toFixed(3) + "\n"

while(pass<=pass_no){
   
   g+="g1z-"+ (pass_depth*pass) + "f" + material.plunge + "\n"
   g+="g1f" + material.feed + "\n"
   for(i=1;i<path1.length;i++){
      g+="g1x"+(path1[i].X).toFixed(3) +"y"+ (path1[i].Y).toFixed(3) + "\n"
   }
   pass++
}

g+="g0z5\n"
g+="m5\n"
g+="m30\n"


////////////////////
}


if(filetype=="sbp"){
/////////////////////////////sbp
g+="VD,3,1\n"
g+="MS," + (material.feed/60).toFixed(1) + "," + (material.plunge/60).toFixed(1) + "\n"
g+="JZ,5\n"
g+="SO,1,1\n"
g+="PAUSE 3\n" 

//drill connect holes
/*
   for(i=0;i<connect.length;i++){

		pass_no = 5
		pass = 1
		g+="g0x"+(connect[i].X.toFixed(3))+"y"+ (connect[i].Y).toFixed(3) + "\n"

		while(pass<=pass_no){
	   	g+="g1z-"+ (pass_depth*pass) + "f" + material.plunge + "\n"
			g+="g0z1\n"
			pass++
		}
		
	}
*/
  

   for(i=0;i<vias.length;i++){

		pass_no = 4
		pass = 1
		g+="J2,"+(vias[i][0].X.toFixed(3))+","+ (vias[i][0].Y).toFixed(3) + "\n"

		while(pass<=pass_no){
	   g+="MZ,-"+ (pass_depth*pass) + "\n"
			for(j=0;j<vias[i].length;j++){
   	   	g+="M2,"+(vias[i][j].X).toFixed(3) +","+ (vias[i][j].Y).toFixed(3) + "\n"
			}
		pass++
   	}
		g+="MZ,2\n"
	}

   for(i=0;i<pins.length;i++){
		g+="J2,"+(pins[i][0].X.toFixed(3))+","+ (pins[i][0].Y).toFixed(3) + "\n"
	   g+="MZ,-"+ (0.2) + "\n"
			for(j=1;j<pins[i].length;j++){
				g+="M2,"+(pins[i][j].X.toFixed(3))+","+ (pins[i][j].Y).toFixed(3) + "\n"		
			}
		g+="JZ,2\n"
	}

	//drill vias

   for(i=0;i<net.length;i++){
		
   	for(j=0;j<net[i].length;j++){
		pass_no = 5
		pass = 1
		if(((Math.abs(net[i][j].Y))<21)&&(net[i][j].D==true)){
			g+="J2,"+(net[i][j].X.toFixed(3))+","+ (net[i][j].Y).toFixed(3) + "\n"
				while(pass<=pass_no){
	   			g+="MZ,-"+ (pass_depth*pass) + "\n"
					g+="JZ,1\n"
					pass++
				}
			g+="JZ,2\n"
		}
		}
	}
	
	//

	outlines.reverse()

   for(i=0;i<outlines.length;i++){
		g+="J2,"+(outlines[i][0].X/scale.toFixed(3))+","+ (outlines[i][0].Y/scale).toFixed(3) + "\n"
	   g+="MZ,-"+ (0.2) + "\n"
			for(j=1;j<outlines[i].length;j++){
				g+="M2,"+(outlines[i][j].X/scale.toFixed(3))+","+ (outlines[i][j].Y/scale).toFixed(3) + "\n"		
			}
		g+="JZ,2\n"
	}

pass_no = 4
pass = 1

path1.reverse()
path1[0]={X:0,Y:parseFloat(ymax+tool)}
path1.push(path1[0])

g+="J2,"+(path1[0].X.toFixed(3))+","+ (path1[0].Y).toFixed(3) + "\n"

while(pass<=pass_no){
   
   g+="MZ,-"+ (pass_depth*pass) + "\n"
   for(i=1;i<path1.length;i++){
      g+="M2,"+(path1[i].X).toFixed(3) +","+ (path1[i].Y).toFixed(3) + "\n"
   }
   pass++
}

g+="MZ,5\n"
g+="SO,1,0\n"


////////////////////
}

//console.log(g)


fabmo.submitJob({
   file : g,
   filename : 'shield.SBP',
   name : "Arduino Shield",
   description : (xmax*2) + " x " + (ymax*2) + " x " + "mm " + "(1/32\" endmill)" 
});

	g=""


}

</script>


</body>
</html>

